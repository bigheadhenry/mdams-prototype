# 实施计划：元数据提取后端化改造

## 目标

1. **移除**前端 `exifr` 库，减轻客户端负载，但保留 SHA256 哈希计算以确保数据完整性。
2. **新增**后端 `exiftool` 支持，在服务器端提取元数据。
3. **更新**前端 Dashboard 列表页，展示后端提取的“图片宽高”和“拍摄时间”。

## 技术实施步骤

### 1. 后端改造 (Backend)

* **环境依赖 (`backend/Dockerfile`)**:

  * 安装 `libimage-exiftool-perl` 系统包。

* **依赖管理 (`backend/requirements.txt`)**:

  * 不需要引入 `PyExifTool`，我们将使用 Python 标准库 `subprocess` 直接调用 `exiftool -j` (JSON 模式)，这样更轻量且无需额外的 Python 依赖维护。

* **业务逻辑 (`backend/app/routers/ingest.py`)**:

  * 修改 `ingest_sip` 函数。

  * 在文件完整性校验通过并重命名为正式文件后，调用 `exiftool`。

  * 提取字段映射：

    * `ImageWidth` -> `width`

    * `ImageHeight` -> `height`

    * `DateTimeOriginal` / `CreateDate` -> `date_created`

  * 将这些字段存入数据库的 `metadata_info` JSON 字段中。

### 2. 前端改造 (Frontend)

* **Worker 脚本 (`frontend/src/workers/hashWorker.ts`)**:

  * 删除 `import exifr`。

  * 删除 `exifr.parse()` 调用逻辑。

  * 保留 `crypto.subtle.digest` 哈希计算逻辑。

* **依赖清理 (`frontend/package.json`)**:

  * 卸载 `exifr`。

* **入库组件 (`frontend/src/components/IngestDemo.tsx`)**:

  * 移除前端元数据展示代码。

  * 上传成功后，直接使用服务器返回的元数据进行简单展示。

* **主应用/仪表盘 (`frontend/src/App.tsx`)**:

  * 修改 `columns` 定义。

  * 新增“尺寸”列：读取 `record.metadata_info?.width` 和 `height`。

  * 新增“拍摄时间”列：读取 `record.metadata_info?.date_created`。

  * 注意：需要更新 TypeScript 接口 `Asset` 以包含 `metadata_info` 字段。

## 验证计划

1. 上传一张带有 Exif 信息的 JPG 图片。
2. 观察 Dashboard 列表，确认“尺寸”和“拍摄时间”列正确显示了数据。
3. 观察上传过程，确认 Fixity Check 依然通过（前端 Hash == 后端 Hash）。


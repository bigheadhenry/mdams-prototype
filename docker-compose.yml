services:
  backend:
    build: ./backend
    container_name: meam-backend
    restart: always
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql://meam:meam_secret@db:5432/meam_db
      - REDIS_URL=redis://redis:6379/0
      # Optimize pyvips for low memory environment
      - VIPS_DISC_THRESHOLD=100m
      - VIPS_CONCURRENCY=2
      # Public URLs for IIIF Manifest generation
      # 用于 IIIF Manifest 生成的公共 URL
      # Change 192.168.5.13 to your server IP
      - API_PUBLIC_URL=http://192.168.5.13:3000/api
      # Use Nginx proxy for Cantaloupe to avoid direct port exposure and CORS issues
      # 使用 Nginx 代理 Cantaloupe 以避免直接端口暴露和 CORS 问题
      - CANTALOUPE_PUBLIC_URL=http://192.168.5.13:3000/iiif/2
    volumes:
      # Map NAS mount point directly
      - /sunjing/project/文物库:/app/uploads
    depends_on:
      - db
      - redis

  celery_worker:
    build: ./backend
    container_name: meam-worker
    restart: always
    command: celery -A app.celery_app worker --loglevel=info --concurrency=1
    environment:
      - DATABASE_URL=postgresql://meam:meam_secret@db:5432/meam_db
      - REDIS_URL=redis://redis:6379/0
      # Optimize pyvips for low memory environment
      - VIPS_DISC_THRESHOLD=100m
      - VIPS_CONCURRENCY=2
    volumes:
      # Map NAS mount point directly
      - /sunjing/project/文物库:/app/uploads
    depends_on:
      - db
      - redis

  redis:
    image: redis:7-alpine
    container_name: meam-redis
    restart: always
    ports:
      - "6379:6379"


  frontend:
    build: ./frontend
    container_name: meam-frontend
    restart: always
    ports:
      - "3000:80"
    volumes:
      - ./frontend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
      - cantaloupe

  db:
    image: postgres:16-alpine
    container_name: meam-db
    restart: always
    environment:
      - POSTGRES_USER=meam
      - POSTGRES_PASSWORD=meam_secret
      - POSTGRES_DB=meam_db
    volumes:
      # Use local SSD for DB performance as requested
      # 按照要求使用本地 SSD 提升 DB 性能
      - ./db_data:/var/lib/postgresql/data
    deploy:
      resources:
        limits:
          memory: 2G

  # Optional: File browser to inspect uploaded assets
  # 可选: 用于检查已上传资产的文件浏览器
  filebrowser:
    image: filebrowser/filebrowser:latest
    container_name: meam-filebrowser
    restart: always
    ports:
      - "8081:80"
    volumes:
      # Map NAS path to /srv
      - /sunjing/project:/srv
      # Local SSD for DB to avoid NFS locks
      - ./filebrowser.db:/database/filebrowser.db
    command: /filebrowser --noauth

  # IIIF Server for high-resolution image serving
  # 用于高分辨率图像服务的 IIIF 服务器
  cantaloupe:
    # Build locally to avoid docker hub issues
    # 本地构建以避免 Docker Hub 问题
    build: ./cantaloupe
    image: meam-cantaloupe:local
    container_name: meam-cantaloupe
    restart: always
    ports:
      - "8182:8182"
    volumes:
      # Read images directly from NAS
      - /sunjing/project/文物库:/var/lib/cantaloupe/images
      - ./cantaloupe.properties:/etc/cantaloupe.properties
      # Pass host entropy to container
      - /dev/urandom:/dev/random:ro
    environment:
      - CANTALOUPE_CONFIG=/etc/cantaloupe.properties
      # Java Heap constraint for N100 (16GB total, leave room for others)
      # Add java.security.egd to fix slow startup due to entropy pool issues
      - JAVA_OPTS=-Xmx4g -Djava.security.egd=file:/dev/./urandom
      # Ensure UTF-8 support for filenames
      - LANG=C.UTF-8
      - LC_ALL=C.UTF-8

volumes:
  meam_pg_data:
